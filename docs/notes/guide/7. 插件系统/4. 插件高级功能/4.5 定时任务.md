---
title: å®šæ—¶ä»»åŠ¡
createTime: 2025/03/27 10:07:54
permalink: /guide/timertask/
---

## æ¦‚è¿°

`TimeTaskMixin` æ˜¯ä¸€ä¸ªå¼ºå¤§çš„å®šæ—¶ä»»åŠ¡è°ƒåº¦æ··å…¥ç±»ï¼Œä¸º**æ’ä»¶**æä¾›äº†çµæ´»çš„å®šæ—¶ä»»åŠ¡ç®¡ç†åŠŸèƒ½ã€‚æ”¯æŒå¤šç§æ—¶é—´æ ¼å¼ã€æ¡ä»¶è§¦å‘ã€å‚æ•°åŠ¨æ€ç”Ÿæˆç­‰é«˜çº§ç‰¹æ€§ã€‚

## åŸºæœ¬ç”¨æ³•

### æ”¯æŒçš„æ—¶é—´æ ¼å¼

#### é—´éš”ä»»åŠ¡

- åŸºç¡€å•ä½ï¼š`"30s"`, `"5m"`, `"2h"`, `"1d"`
- ç»„åˆæ ¼å¼ï¼š`"2h30m"`, `"1d12h"`
- å†’å·åˆ†éš”ï¼š`"00:05:30"` (æ—¶:åˆ†:ç§’)
- è‡ªç„¶è¯­è¨€ï¼š`"2å¤©3å°æ—¶5ç§’"`

```python
class MyPlugin(NcatBotPlugin):
    async def on_load(self):
        self.add_scheduled_task(
            self.interval_task,
            "interval_task",
            "1h",
        )
    async def interval_task(self):
        print("é—´éš”æ‰§è¡Œ")
```

#### æ¯æ—¥å®šç‚¹ä»»åŠ¡

- æ ¼å¼ï¼š`"09:30"`, `"23:59"`

```python
class MyPlugin(NcatBotPlugin):
    async def on_load(self):
        self.add_scheduled_task(
            self.daily_task,
            "daily_task",
            "09:30",
        )
    async def daily_task(self):
        print("æ¯æ—¥å®šç‚¹æ‰§è¡Œ")
```

#### ä¸€æ¬¡æ€§ä»»åŠ¡

- æ ‡å‡†æ ¼å¼ï¼š`"2025-12-31 23:59:59"`
- GitHub æ ¼å¼ï¼š`"2025:12:31-23:59:59"`

```python
class MyPlugin(NcatBotPlugin):
    async def on_load(self):
        self.add_scheduled_task(
            self.once_task,
            "once_task",
            "2025-12-31 23:59:59",
        )
    async def once_task(self):
        print("ä¸€æ¬¡æ€§ä»»åŠ¡æ‰§è¡Œ")
```

### 2. é«˜çº§åŠŸèƒ½

#### æ¡ä»¶æ‰§è¡Œ

```python
def is_working_time():
    return 9 <= datetime.now().hour <= 18

class MyPlugin(NcatBotPlugin):
    async def on_load(self):
        self.add_scheduled_task(
            self.work_task,
            "work_task",
            "1h",
            conditions=[is_working_time]
        )
    async def work_task(self):
        print("å·¥ä½œæ—¶é—´ä»»åŠ¡æ‰§è¡Œ")
```

#### é™åˆ¶æ‰§è¡Œæ¬¡æ•°

```python
# åªæ‰§è¡Œ5æ¬¡
class MyPlugin(NcatBotPlugin):
    async def on_load(self):
        self.add_scheduled_task(
            self.limited_task, 
            "limited_task", 
            "10s",
            max_runs=5
        )
    async def limited_task(self):
        print("æœ‰é™æ¬¡ä»»åŠ¡æ‰§è¡Œ")
```

#### åŠ¨æ€å‚æ•°ç”Ÿæˆ

```python
def get_current_data():
    return {"timestamp": time.time()}

class MyPlugin(NcatBotPlugin):
    async def on_load(self):
        self.add_scheduled_task(
            self.data_task,
            "data_task", 
            "30s",
            kwargs_provider=get_current_data
        )
    async def data_task(self, timestamp):
        print(f"ä»»åŠ¡æ‰§è¡Œæ—¶é—´æˆ³: {timestamp}")
```

## å®Œæ•´ç¤ºä¾‹

```python
class TimeTaskDemo(NcatBotPlugin):
    name = "TimeTaskDemo"
    
    async def on_load(self):
        # æ¯5ç§’æ‰§è¡Œä¸€æ¬¡
        self.add_scheduled_task(self.heartbeat, "heartbeat", "5s")
        
        # æ¯å¤©ä¸Šåˆ9ç‚¹æ‰§è¡Œ
        self.add_scheduled_task(self.daily_report, "daily", "09:00")
        
        # å¸¦æ¡ä»¶çš„ä»»åŠ¡
        self.add_scheduled_task(
            self.conditional_task, 
            "conditional", 
            "1m",
            conditions=[self.is_active]
        )
    
    async def heartbeat(self):
        print("ğŸ’“ å¿ƒè·³æ£€æµ‹")
    
    async def daily_report(self):
        print("ğŸ“Š ç”Ÿæˆæ—¥æŠ¥")
    
    async def conditional_task(self):
        print("âœ… æ¡ä»¶æ»¡è¶³ï¼Œæ‰§è¡Œä»»åŠ¡")
    
    def is_active(self):
        return True  # ä½ çš„æ¡ä»¶é€»è¾‘
```

## ä»»åŠ¡ç®¡ç†

### ç§»é™¤ä»»åŠ¡

```python
# ç§»é™¤æŒ‡å®šä»»åŠ¡
self.remove_scheduled_task("task_name")
```

## æ³¨æ„äº‹é¡¹

1. **ä»»åŠ¡åç§°å”¯ä¸€æ€§**ï¼šæ¯ä¸ªä»»åŠ¡å¿…é¡»æœ‰å”¯ä¸€çš„åç§°æ ‡è¯†
2. **å¼‚æ­¥æ”¯æŒ**ï¼šæ”¯æŒå¼‚æ­¥å’ŒåŒæ­¥å‡½æ•°
3. **èµ„æºæ¸…ç†**ï¼šæ’ä»¶å¸è½½æ—¶ä¼šè‡ªåŠ¨æ¸…ç†ç›¸å…³ä»»åŠ¡


